# .gitlab-ci.yml - Deploy 100% automático para GitLab Pages
# Configuração otimizada para Pedro Tiago Contabilidade
# Email: pedrotiagofaria25@gmail.com

stages:
  - test
  - build
  - deploy
  - notify

variables:
  NODE_VERSION: "18"
  NODE_ENV: "production"
  # Cache configurado para máxima performance
  CI_DEBUG_TRACE: "false"
  FF_USE_FASTZIP: "true"
  ARTIFACT_COMPRESSION_LEVEL: "fastest"
  CACHE_COMPRESSION_LEVEL: "fastest"

# Cache otimizado para node_modules
cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - node_modules/
    - .npm/
  policy: pull-push

# Stage de testes rápidos
lint_and_test:
  stage: test
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline --no-audit --progress=false
  script:
    - npm run lint
    - npm run type-check
    - npm run test
  artifacts:
    reports:
      junit: coverage/junit.xml
    expire_in: 1 hour
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  only:
    - merge_requests
    - main
    - develop

# Build otimizado para produção
build:
  stage: build
  image: node:$NODE_VERSION-alpine
  before_script:
    - npm ci --cache .npm --prefer-offline --no-audit --progress=false
  script:
    - echo "Building for Pedro Tiago Contabilidade - www.pedrotiagocontabilidade.com.br"
    - npm run build:production
    - echo "Build completed successfully"
    - ls -la dist/
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - main

# Deploy GitLab Pages otimizado
pages:
  stage: deploy
  image: alpine:latest
  dependencies:
    - build
  script:
    - echo "Deploying to GitLab Pages for domain www.pedrotiagocontabilidade.com.br"
    - mkdir -p public
    - cp -r dist/* public/
    - cp CNAME public/
    - echo "www.pedrotiagocontabilidade.com.br" > public/CNAME
    - ls -la public/
    - echo "GitLab Pages deployment completed"
  artifacts:
    paths:
      - public
    expire_in: 1 day
  only:
    - main

# Notificação de sucesso
notify_success:
  stage: notify
  image: alpine:latest
  dependencies: []
  script:
    - echo "✅ Deploy concluído com sucesso!"
    - echo "🌐 Site disponível em: https://pedrotiagofaria25.gitlab.io/pedro-tiago-contabilidade"
    - echo "🔗 Domínio customizado: www.pedrotiagocontabilidade.com.br"
    - echo "📧 Responsável: pedrotiagofaria25@gmail.com"
  only:
    - main
  when: on_success

# Notificação de falha
notify_failure:
  stage: notify
  image: alpine:latest
  dependencies: []
  script:
    - echo "❌ Deploy falhou!"
    - echo "📧 Verificar configurações em: pedrotiagofaria25@gmail.com"
    - echo "🔧 Verificar logs do pipeline"
  only:
    - main
  when: on_failure